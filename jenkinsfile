node {
  def gitcommit //Definición de variable para ver el id del commit
  environment{
      DOCKERHUB_CREDENTIALS = credentials('dockerhub')
  }
  stage('Verificación SCM') {
    checkout scm //Clona el repo en jenkins
    sh "git rev-parse --short HEAD > .git/commit-id"//Ejecución en shell para almacenar el commit id en el archivo temporal .git/commit-id                        
    gitcommit = readFile('.git/commit-id').trim() //Almacenamos el contenido el archivo temporal .git/commit-id en la variable gitcommit
  }
  stage('test') {
    nodejs(nodeJSInstallationName: 'nodejs') { //Indicación de la instalación de NodeJs en jenkins
      sh 'npm install --only=dev'
      sh 'npm test'
    }
  }
  stage('Docker login'){
    steps{
      sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u DOCKERHUB_CREDENTIALS_USR --password-stdin'           
    }
  }
  stage('Docker Build & Push') {
    docker.withRegistry('https://registry.hub.docker.com', 'dockerhub') { //Loguearse a Docker con el registro de credenciales 'docker-hub' contenido en Jenkins
      def nuestraapp = docker.build("maxirobledo/nodejsapp:${gitcommit}", ".") //Definción de la variable que construye la app con el el etiquetado del commit id
      nuestraapp.push()
    }
  }
}
